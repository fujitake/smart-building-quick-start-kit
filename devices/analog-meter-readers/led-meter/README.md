[English](./README.en.md)

# LEDリーダー

LEDランプの色を読み取り、MQTT Broker に読み取った値を送信する手順です。

## 仕様

### LED の読み取り

LED の点灯状態は OpenCV を用いた画像処理にて実現しています。
緑(OpenCV の色空間の色相 65-70)や赤(OpenCV の色空間の色相 175-180)色を読み取るようチューニングしており、この色が画像中で検出された場合に「点灯」とみなします。

現時点では「画像中に緑や赤色が存在していたか否か」を判定しているのみなので、
対象となる LED 1つのみを大きく映すことが正常に動作させる条件となっています。

## セットアップ

### 必要なもの

- 検出対象にするLEDランプ
> 本手順で使用するスクリプトは、サンプル画像でも動作させることができます。サンプル画像を使う処理はコメントアウトされておりますので、必要な場合は該当箇所のコメントを解除してください。

- カメラ付き PC ※ 本手順の検証では MacBook Pro(2018)を使用しています

- 本ディレクトリ一式

### 手順

1. OpenCV インストール
   MacOS では、以下のコマンドでインストールします。

```sh
$ brew install opencv
```

2. led_status_observer.py と同じディレクトリに`requirements.txt` ファイルを設置し、サンプルスクリプトに必要な Python モジュールをインストールします

```
$ pip3 install -r requirements.txt
```

3. 秘匿情報等は環境変数としてスクリプトへ読み込みます  
   `.env.sample` ファイルをコピーして `.env` ファイルを作成し、ファイル内の説明に沿った値を設定してください

## 緑や赤の LED 検出

`led_status_observer.py`を実行して、緑や赤の LED を検出し、MQTT Broker にデータを送信します。

```sh
$ python3 led_status_observer.py

```

## 送信詳細

| 項目         | 内容                  |
| ------------ | --------------------- |
| プロトコル   | MQTTS                 |
| 頻度         | 30 秒ごとに 1 回送信  |
| フォーマット | JSON                  |

```JSON
{
  "sensor_id": "string",
  "sensing_value": "string",
  "timestamp": int
}
```

## 注意点

- 対象となる LED 1 つのみを大きく映さないと、LED の点灯を正しく検出することができません。
- 2つ以上のLEDがカメラに写っている場合は正しく動作しません。
- 赤、緑のみ検出することができます。
- 使用するカメラの種類で画像の色味が変わることに注意してください。
- MQTT Broker との通信経路の暗号化・認証は簡易的なものなので、実際の案件で求められるセキュリティレベルに応じて対策ください。
