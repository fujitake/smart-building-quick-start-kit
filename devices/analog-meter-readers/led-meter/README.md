[English](./README.en.md)

# LEDリーダー

LEDランプの色を読み取り、MQTTブローカーに読み取った値を送信する手順です。

## 仕様

### LED の読み取り

LED の点灯状態は OpenCV を用いた画像処理にて実現しています。
緑(OpenCV の色空間の色相 65-70)や赤(OpenCV の色空間の色相 175-180)色を読み取るようチューニングしており、この色が画像中で検出された場合に「点灯」とみなします。

現時点では「画像中に緑や赤色が存在していたか否か」を判定しているのみなので、
対象となる LED 1つのみを大きく映すことが正常に動作させる条件となっています。

## セットアップ

### 必要なもの

- 検出対象にするLEDランプ
> 本手順で使用するスクリプトは、サンプル画像でも動作させることができます。サンプル画像を使う処理はコメントアウトされておりますので、必要な場合は該当箇所のコメントを解除してください。

- カメラ付き PC ※ 本手順の検証では MacBook Pro(2018)を使用しています

- 本ディレクトリ一式

### 手順

1. OpenCV インストール
   MacOS では、以下のコマンドでインストールします。

```sh
$ brew install opencv
```

2. led_status_observer.py と同じディレクトリに`requirements.txt` ファイルを設置し、アプリケーションに必要な Python モジュールをインストールします

```
$ pip3 install -r requirements.txt
```

3. 秘匿情報等は環境変数としてスクリプトへ読み込みます  
   `.env.sample` ファイルをコピーして `.env` ファイルを作成し、ファイル内の説明に沿った値を設定してください

## 緑や赤の LED 検出

`led_status_observer.py`を実行して、緑や赤の LED を検出し、VANTIQ にデータを送信します。

```sh
$ python3 led_status_observer.py

```

## 送信詳細

| 項目         | 内容                  |
| ------------ | --------------------- |
| プロトコル   | MQTTS                 |
| 頻度         | 30 秒ごとに 1 回送信  |
| フォーマット | JSON                  |

```
{
  "sensor_id": "string",
  "sensing_value": "string",
  "timestamp": int
}
```

## 注意点

- 対象となる LED1 つのみを大きく映さないと、正しく LED の点灯を検出することができません。
- 画像で「色が存在しているか」で「点灯」を判断しているため、LED が二つになったら「点灯」を判断ロジックを変える必要があります。
- LED 他に緑や赤色のものがないことを前提としてます。画像で「色が存在しているか」で「点灯」を判断しているため、LED 他に緑や赤色のものがありましたら、LED「点灯」だと誤解される恐れがあります。
- 同じメーカーのカメラを使うことをお勧めします。カメラ次第で撮った画像の色が異なります。
- MQTT Broker との通信経路の暗号化・認証は簡易的なものなので、実際の案件で求められるセキュリティレベルに応じて対策ください。
